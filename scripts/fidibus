#!/usr/bin/env python
#
# -----------------------------------------------------------------------------
# Copyright (c) 2015-2016   Daniel Standage <daniel.standage@gmail.com>
# Copyright (c) 2015-2016   Indiana University
#
# This file is part of genhub (http://github.com/standage/genhub) and is
# licensed under the BSD 3-clause license: see LICENSE.txt.
# -----------------------------------------------------------------------------

from __future__ import print_function
import argparse
import importlib
import multiprocessing
import os
import subprocess
import sys
import genhub

tasks = [
    'list',       # show info about reference genomes
    'download',   # retrieve or check genome data files
    'prep',       # pre-process reference genome data files
    'iloci',      # compute iLoci
    'breakdown',  # parse annotations and sequences for various genome features
    'stats',      # compute descriptive statistics on various genome features
    'cluster',    # cluster iLocus protein products
    'cleanup',    # remove intermediate/ancillary data files
]


def getdb(label, config, args):
    assert 'source' in config
    assert config['source'] in sources
    constructor = genhub.dbtype[config['source']]
    db = constructor(label, config, workdir=args.workdir)
    return db


def list_configs(registry):
    print('===== Reference genomes =====')
    for label, config in registry.list_genomes():
        info = label + '\t' + config['species']
        if 'common' in config:
            info += ' ({})'.format(config['common'])
        info += '\t' + genhub.sources[config['source']]
        print(info)
    print('')

    print('===== Batch configurations =====')
    for label, batch in registry.list_batches():
        print(label, '\t', ','.join(batch))


def run_build(builddata):
    label, config, args = builddata
    db = getdb(label, config, args)

    if 'download' in args.task:
        assert label != 'Dpul', (
            '"download" task not available for Daphnia pulex (Dpul) genome; '
            'see https://github.com/standage/genhub/blob/master/docs/DPUL.md '
            'for more details'
        )
        db.download()
    if 'format' in args.task:
        db.format()
    if 'prepare' in args.task:
        genhub.iloci.prepare(db, delta=args.delta, ilcformat=args.format)
        genhub.proteins.prepare(db)
        genhub.mrnas.prepare(db)
        genhub.exons.prepare(db)
    if 'stats' in args.task:
        genhub.stats.compute(db)
    if 'cleanup' in args.task:
        db.cleanup(args.keep, args.fullclean)

    print('[GenHub: %s] build complete!' % db.config['species'],
          file=sys.stderr)


def cluster_proteins(dbs, np=1, cdargs=None):
    print('[GenHub] aggregating representative proteins', file=sys.stderr)
    protmap = dict()
    with open('GenHub.prot.fa', 'w') as outstream:
        for db in dbs:
            protfile = '%s/%s.prot.fa' % (db.dbdir, db.label)
            with open(protfile, 'r') as instream:
                for line in instream:
                    print(line, end='', file=outstream)
            for protid, locid in db.get_prot_map():
                protmap[protid] = locid

    print('[GenHub] clustering representative proteins', file=sys.stderr)
    if cdargs is None:
        cdargs = '-d 0 -c 0.50 -s 0.65 -p 1 -n 3 -aL 0.75 -aS 0.85 -g 1 -M 0'
    if '-T' in cdargs:
        message = ('warning: do not set cd-hit thread count with "-T" in '
                   '"--cdargs", use the "--numprocs" option')
        print(message, file=sys.stderr)
    cdargs = '-T {} {}'.format(np, cdargs)
    command = ('cd-hit -i GenHub.prot.fa -o GenHub.prot ' + cdargs).split()
    subprocess.check_call(command)

    with open('GenHub.prot.clstr', 'r') as infile, \
            open('GenHub.hiloci.tsv', 'w') as outfile:
        for clusterid, clusterseqs in genhub.cdhit.parse_clusters(infile):
            iloci = [protmap[prot.accession] for prot in clusterseqs]
            species = set([prot.species for prot in clusterseqs])
            print(len(iloci), len(species), ','.join(iloci), ','.join(species),
                  sep='\t', file=outfile)


def get_parser():
    desc = '"LocusPocus Fidibus": process and summarize genome data'
    parser = argparse.ArgumentParser(description=desc)
    parser._optionals.title = 'basic configuration'

    parser.add_argument('-v', '--version', action='version',
                        version='GenHub v%s' % genhub.__version__)
    parser.add_argument('-w', '--workdir', metavar='WD', default='./species',
                        help='working directory for data files; default is '
                        '"./species"')
    parser.add_argument('-p', '--numprocs', metavar='P', type=int, default=1,
                        help='number of processors to use when processing '
                        'multiple genomes; default is 1')
    parser.add_argument('task', nargs='+', choices=tasks, metavar='task',
                        help='build task(s) to execute; options include '
                        '"%s"' % '", "'.join(tasks))

    ilcconf = parser.add_argument_group('iLocus configuration')
    ilcconf.add_argument('-d', '--delta', type=int, metavar='DLT', default=500,
                         help='iLocus extension parameter; default is 500')
    ilcconf.add_argument('-f', '--format', metavar='PFX', default='{}ILC-%05lu',
                         help='format for assigning serial labels to iLoci; '
                         'must include the placeholder {} for the species '
                         'label, as well as a printf-style placeholder for a '
                         'serial number; default is "{}ILC-%%05lu"')

    refrconf = parser.add_argument_group('reference genome configuration')
    confargs = refrconf.add_mutually_exclusive_group()
    confargs.add_argument('-g', '--genome', default=None, metavar='LBL',
                          help='label (or comma-separated set of labels) '
                          'specifying the genome(s) to process; use the '
                          '`list` task to show all available genomes')
    confargs.add_argument('-b', '--batch', default=None, metavar='LBL',
                          help='label of a batch of genomes to process; use '
                          'the `list` task to show all available '
                          'batches')
    refrconf.add_argument('-c', '--cfgdir', default=None, metavar='DIR',
                          help='directory (or comma-separated list of '
                          'directories) from which to load user-supplied '
                          'reference genome configuration files')

    miscconf = parser.add_argument_group('miscellaneous settings')
    miscconf.add_argument('--keep', metavar='PTN', nargs='+',
                        help='keep files matching the specified pattern(s) '
                        'when running the `cleanup` build task')
    miscconf.add_argument('--fullclean', action='store_true',
                        help='when running the `cleanup` build task, delete '
                        'original (downloaded) data files as well as processed'
                        ' data files')
    miscconf.add_argument('--cdargs', metavar='ARGS', default=None,
                        help='arguments for cd-hit (cluster task only); '
                        'default is "-d 0 -c 0.50 -s 0.65 -p 1 -n 3 -aL 0.75 '
                        '-aS 0.85 -g 1"; do not use cd-hit\'s "-T" option, '
                        'use this program\'s "--numprocs" option instead')
    return parser


def main(args):
    registry = genhub.registry.Registry()
    if args.cfgdir:
        for cfgdirpath in args.cfgdir.split(','):
            registry.update(cfgdirpath)

    if 'list' in args.task:
        list_configs(registry)
        sys.exit(0)

    if args.genome:
        labels = args.genome.split(',')
        conf = registry.genomes(labels)
        assert conf is not None, 'unknown genome label(s) "%s"' % args.genome
    elif args.batch:
        conf = registry.batch(args.batch)
        assert conf is not None, 'unknown batch label "%s"' % args.batch
    else:
        message = ('must specify a genome or batch of genomes to process, '
                   'or `list` to show available genomes')
        raise ValueError(message)

    builds = list()
    for label in sorted(conf):
        builddata = (label, conf[label], args)
        builds.append(builddata)
    pool = multiprocessing.Pool(processes=args.numprocs)
    results = [pool.apply_async(run_build, args=(b,)) for b in builds]
    _ = [p.get() for p in results]

    if 'cluster' in args.task:
        dbs = [getdb(label, conf[label], args) for label in sorted(conf)]
        cluster_proteins(dbs, np=args.numprocs, cdargs=args.cdargs)

    print('[GenHub] all builds complete!', file=sys.stderr)


if __name__ == '__main__':
    main(get_parser().parse_args())
